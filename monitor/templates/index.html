{% extends 'base.html' %}


{% block title %}CHAMPSS Timing Monitor{% endblock %}

{% block content %}
    <h3>Dashboard</h3>
    <div class="card" style="margin-bottom: 15px; " xmlns="http://www.w3.org/1999/html">
        <div class="card-body">
            <div class="heatmap" id="heatmap"></div>
            <div class="heatmap" id="heatmap_legend" style="flex-direction: row-reverse; height: 15px; "></div>
        </div>
    </div>
    <script>
        var values = {{ sources.heatmap["val_normalized"] | safe }};
        var counts = {{ sources.heatmap["val"] | safe }};
        var dates = {{ sources.heatmap["key"] | safe }};

        function generateHeatmap() {
            const heatmap = document.getElementById("heatmap");

            for (let i = 0; i < values.length; i++) {
                const square = document.createElement("a");
                square.classList.add("square");
                square.setAttribute("value", values[i]);

                if(values[i] > 1) {
                    values[i] = 1;
                }

                if (values[i] === 0) {
                    square.style.backgroundColor = "#eee";
                    square.style.opacity = 1;
                } else {
                    // square.style.backgroundColor = "#003200";
                    square.style.backgroundColor = "#000";
                    square.style.opacity = values[i] / 1;
                }

                if(square.style.opacity < 0.2) {
                    square.style.opacity = 0.2;
                }

                square.setAttribute("data-bs-toggle", "tooltip");
                square.setAttribute("data-bs-placement", "top");

                if(counts[i] > 0){
                    square.setAttribute("data-bs-title", counts[i] + " TOA(s) on " + dates[i]);
                } else {
                    square.setAttribute("data-bs-title", "No TOA on " + dates[i]);
                }

                heatmap.appendChild(square);
            }

            const legend_data = [0, 0.2, 0.4, 0.6, 0.8, 1]
            const legend = document.getElementById("heatmap_legend");

            // add "less" on the left in text
            const less = document.createElement("span");
            less.style = "font-size: 0.75em; padding-left: 7px; padding-right: 7px;"
            less.innerHTML = "Less";
            legend.appendChild(less);

            for (let i = 0; i < legend_data.length; i++) {
                const square = document.createElement("a");
                square.classList.add("square");
                square.setAttribute("value", legend_data[i]);

                if (legend_data[i] === 0) {
                    square.style.backgroundColor = "#eee";
                    square.style.opacity = 0.75;
                } else {
                    // square.style.backgroundColor = "#216e39";
                    // square.style.backgroundColor = "#003200";
                    square.style.backgroundColor = "#000";
                    square.style.opacity = legend_data[i] / 1;
                }

                if(square.style.opacity < 0.2) {
                    square.style.opacity = 0.2;
                }

                legend.appendChild(square);
            }

            // add "more" on the right in text
            const more = document.createElement("span");
            more.style = "font-size: 0.75em; padding-left: 7px; padding-right: 7px;";
            more.innerHTML = " More";
            legend.appendChild(more);

        }

        generateHeatmap();
    </script>
    <div class="row">
        {% for this_source in sources %}
            <div class="col-lg-6" id="div_{{this_source.psr_id_esc}}" style="cursor:pointer;">
                <div class="card" style="margin-bottom: 15px; " xmlns="http://www.w3.org/1999/html">
                    <div class="card-body">
                        <small style="float: right; ">Updated on {{this_source.get_last_updated()}}</small>
                        <h4 style="margin-bottom: 0;">{{this_source.psr_id}}</h4>

                        <div class="collapse" id="diagnostic_pdf_{{this_source.psr_id_esc}}">
                            <br>
                            <center></center><small>Double-click to view full diagnostic information.</small></center>
                            <object id="diagnostic_pdf" data="/diagnostic/{{this_source.psr_id}}/pdf" type="application/pdf" style="width: 100%; aspect-ratio: 1.77; border: 0; border-radius: 5px; "></object>
                        </div>

                        <div id="resids_{{this_source.psr_id_esc}}" style="width:100%;height:5em;"></div>

                        <script>
                            // $('#div_{{this_source.psr_id_esc}}').on('click', function() {
                            //     // If already open, go to top of page
                            //     if ($('#diagnostic_pdf_{{this_source.psr_id_esc}}').hasClass('show')) {
                            //         $('.collapse').collapse('hide');
                            //         return
                            //     }
                            //
                            //     $('.collapse').collapse('hide');
                            //     $('#diagnostic_pdf_{{this_source.psr_id_esc}}').collapse('toggle');
                            //     console.log('clicked');
                            // });
                            //
                            // $('#div_{{this_source.psr_id_esc}}').on('dblclick', function() {
                            //     window.location.href='/diagnostic/{{this_source.psr_id}}';
                            // });

                            $('#div_{{this_source.psr_id_esc}}').on('click', function() {
                                window.location.href='/diagnostic/{{this_source.psr_id}}';
                            });
                        </script>

                        <script>
                            var resids = {{this_source.get_resids() | safe}};
                            var resids_plot = {
                                x: resids["mjd"],
                                y: resids["val"],
                                error_y: {
                                    type: 'data',
                                    array: resids["err"],
                                    visible: true
                                },
                                mode: 'markers',
                                type: 'scatter',
                                marker: {
                                    color: 'black',
                                    size: 5
                                }
                            };
                            var resids_layout = {
                                // title: 'Residuals for {{this_source.psr_id}}',
                                xaxis: {
                                    // title: 'MJD',
                                    showticklabels: false,
                                    showline: false,
                                    showgrid: false,
                                    zeroline: true
                                },
                                yaxis: {
                                    // title: 'Residual (us)',
                                    showticklabels: false,
                                    showline: false,
                                    showgrid: false,
                                    zeroline: true
                                },
                                showlegend: false,
                                margin: {'t':0,'l':0,'b':0,'r':0}
                            };

                            var zero_line = {
                                x: [resids["mjd"][0], resids["mjd"][resids["mjd"].length-1]],
                                y: [0, 0],
                                mode: 'lines',
                                type: 'scatter',
                                line: {
                                    color: 'grey',
                                    width: 1
                                }
                            };

                            var config = {
                                responsive: true
                            };

                            Plotly.newPlot('resids_{{this_source.psr_id_esc}}', [zero_line, resids_plot], resids_layout, config);
                        </script>
                    </div>
                </div>
            </div>
        {% endfor %}
        <div id="test"></div>
    </div>
<script>
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
</script>
{% endblock %}